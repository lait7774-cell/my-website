<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SmartSpend | èŒå¯µ AI æ”¶æ”¯å„€è¡¨æ¿</title>
    <!-- å¼•å…¥å¤–éƒ¨å‡½å¼åº« -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        :root {
            --primary: #d97706; /* æŸ´çŠ¬é‡‘ */
            --secondary: #fef3c7;
            --accent: #f472b6; /* è‚‰çƒç²‰ */
            --success: #10b981;
            --danger: #ef4444;
            --bg: #fffcf2;
        }

        body {
            font-family: 'PingFang TC', 'Microsoft JhengHei', sans-serif;
            background-color: var(--bg);
            margin: 0;
            padding: 20px;
            color: #451a03;
            background-image: radial-gradient(#fbbf24 0.5px, transparent 0.5px);
            background-size: 20px 20px;
        }

        .dashboard {
            max-width: 900px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
        }

        .card {
            background: rgba(255, 255, 255, 0.9);
            padding: 30px;
            border-radius: 24px;
            box-shadow: 0 10px 25px -5px rgba(217, 119, 6, 0.1);
            border: 2px solid #fde68a;
            position: relative;
            overflow: hidden;
        }

        .full-width { grid-column: 1 / -1; }

        /* --- é˜¿æŸ´åŠ©ç†èˆ‡æˆé•·ç³»çµ±æ¨£å¼ --- */
        .pet-container {
            position: relative;
            width: 120px;
            height: 120px;
            margin: 0 auto 10px;
            background: white;
            border-radius: 50%;
            border: 4px solid var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 4rem;
        }

        .accessory {
            position: absolute;
            font-size: 2.2rem;
            transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            opacity: 0;
            transform: scale(0.5) translateY(20px);
        }

        .accessory.unlocked { opacity: 1; transform: scale(1) translateY(0); }
        #acc-sunglasses { top: 35px; left: 25px; font-size: 2.5rem; }
        #acc-crown { top: -15px; left: 35px; transform: rotate(-15deg) scale(0.5); }
        #acc-crown.unlocked { transform: rotate(-15deg) scale(1.1); }

        /* --- AI åŠ©ç†å°è©±æ¡† --- */
        .ai-chat-box {
            background: #fff;
            border-radius: 20px;
            border: 2px dashed var(--primary);
            padding: 15px;
            margin-top: 15px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .ai-input-area {
            display: flex;
            gap: 10px;
        }

        .ai-input-area input {
            flex: 1;
            padding: 10px 15px;
            border-radius: 30px;
            border: 1px solid #ddd;
        }

        .btn-ai {
            background: var(--primary);
            color: white;
            padding: 10px 20px;
            border-radius: 30px;
            font-size: 14px;
        }

        .ai-status {
            font-size: 12px;
            color: #b45309;
            font-style: italic;
            text-align: left;
            min-height: 18px;
        }

        /* --- åŸæœ‰æ¨£å¼ä¿æŒ --- */
        .growth-status {
            font-size: 0.9rem;
            background: var(--secondary);
            padding: 5px 15px;
            border-radius: 20px;
            display: inline-block;
            margin-top: 5px;
            font-weight: bold;
            color: var(--primary);
        }

        h1 { margin: 10px 0; color: var(--primary); text-align: center; }
        h2 { margin-top: 0; color: var(--primary); display: flex; align-items: center; gap: 10px; }

        .type-toggle { display: flex; background: #f1f5f9; padding: 5px; border-radius: 12px; margin-bottom: 15px; }
        .type-toggle label { flex: 1; text-align: center; padding: 10px; cursor: pointer; border-radius: 8px; font-weight: bold; transition: all 0.3s; }
        .type-toggle input { display: none; }
        #type-expense:checked + label { background: var(--danger); color: white; }
        #type-income:checked + label { background: var(--success); color: white; }

        .input-group { display: flex; flex-direction: column; gap: 15px; }
        input, select { padding: 14px; border: 2px solid #fde68a; border-radius: 12px; font-size: 16px; outline: none; }
        input:focus, select:focus { border-color: var(--primary); }

        button { padding: 14px; border: none; border-radius: 12px; cursor: pointer; font-weight: 700; transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-add { background: var(--primary); color: white; box-shadow: 0 4px 0 #b45309; }
        .btn-add:active { transform: translateY(2px); box-shadow: 0 2px 0 #b45309; }
        
        .summary-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 20px; }
        .summary-item { text-align: center; padding: 15px; background: white; border-radius: 15px; border: 1px solid #fde68a; }
        .summary-value { font-size: 1.2rem; font-weight: bold; }
        .val-income { color: var(--success); }
        .val-expense { color: var(--danger); }

        .history-list { max-height: 300px; overflow-y: auto; margin-top: 15px; }
        .history-item { display: flex; justify-content: space-between; align-items: center; padding: 12px; border-radius: 12px; margin-bottom: 8px; background: #fff; border-left: 8px solid #ccc; }
        .item-income { border-left-color: var(--success); }
        .item-expense { border-left-color: var(--danger); }
        .amount { font-weight: bold; }

        @media (max-width: 768px) { .dashboard { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

<div class="dashboard">
    <!-- é˜¿æŸ´ AI æˆé•·å®¤ -->
    <div class="card full-width" style="text-align: center; background: linear-gradient(135deg, #fffbeb 0%, #fff 100%);">
        <div style="display: flex; align-items: center; justify-content: space-around; flex-wrap: wrap;">
            <div style="flex: 1; min-width: 200px;">
                <div class="pet-container">
                    <span id="pet-main">ğŸ•</span>
                    <span id="acc-sunglasses" class="accessory">ğŸ•¶ï¸</span>
                    <span id="acc-crown" class="accessory">ğŸ‘‘</span>
                </div>
                <div id="growth-text" class="growth-status">æ±ªï¼æˆ‘æ˜¯é˜¿æŸ´ AI åŠ©ç†ğŸ¾</div>
            </div>
            
            <div style="flex: 2; min-width: 300px;">
                <div class="ai-chat-box">
                    <div style="text-align: left; font-weight: bold; color: var(--primary);">âœ¨ æ™ºæ…§è¨˜å¸³ï¼šä¸€å¥è©±å°±æå®šï¼</div>
                    <div class="ai-input-area">
                        <input type="text" id="ai-input" placeholder="ä¾‹å¦‚ï¼šä»Šå¤©æ™šé¤åƒæ‹‰éºµ 200 å…ƒ...">
                        <button class="btn-ai" id="btn-ai" onclick="processAI()">æ±ªï¼è§£æ</button>
                    </div>
                    <div id="ai-status" class="ai-status">ç­‰å¾…æŒ‡ä»¤ä¸­...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- çµé¤˜çµ±è¨ˆå€ -->
    <div class="card full-width">
        <div style="display: flex; gap: 10px; margin-bottom: 15px;">
            <select id="year-filter" onchange="updateUI()"></select>
            <select id="month-filter" onchange="updateUI()">
                <option value="01">1æœˆ</option><option value="02">2æœˆ</option>
                <option value="03">3æœˆ</option><option value="04">4æœˆ</option>
                <option value="05">5æœˆ</option><option value="06">6æœˆ</option>
                <option value="07">7æœˆ</option><option value="08">8æœˆ</option>
                <option value="09">9æœˆ</option><option value="10">10æœˆ</option>
                <option value="11">11æœˆ</option><option value="12">12æœˆ</option>
            </select>
        </div>
        <div class="summary-grid">
            <div class="summary-item"><div>ç¸½æ”¶å…¥</div><div id="total-income" class="summary-value val-income">$0</div></div>
            <div class="summary-item"><div>ç¸½æ”¯å‡º</div><div id="total-expense" class="summary-value val-expense">$0</div></div>
            <div class="summary-item"><div>çµé¤˜</div><div id="total-balance" class="summary-value val-balance">$0</div></div>
        </div>
    </div>

    <!-- æ‰‹å‹•è¼¸å…¥å€ -->
    <div class="card">
        <h2>â• æ‰‹å‹•æ–°å¢</h2>
        <div class="input-group">
            <div class="type-toggle">
                <input type="radio" name="type" id="type-expense" value="æ”¯å‡º" checked>
                <label for="type-expense">ğŸ’¸ æ”¯å‡º</label>
                <input type="radio" name="type" id="type-income" value="æ”¶å…¥">
                <label for="type-income">ğŸ’° æ”¶å…¥</label>
            </div>
            <input type="date" id="record-date">
            <input type="text" id="desc" placeholder="é …ç›®åç¨±...">
            <input type="number" id="amount" placeholder="é‡‘é¡">
            <select id="category">
                <option value="é¤é£²">ğŸ± ç¾é£Ÿé¤é£²</option>
                <option value="äº¤é€š">ğŸš— æ±ªæ±ªå‡ºé–€</option>
                <option value="å¨›æ¨‚">ğŸ® ç©è€ç©å…·</option>
                <option value="å­¸ç¿’">ğŸ“š å­¸ç¿’æˆé•·</option>
                <option value="è–ªæ°´">ğŸ’µ å‹å‹•æ‰€å¾—</option>
                <option value="å…¶ä»–">âœ¨ å…¶ä»–é …ç›®</option>
            </select>
            <button class="btn-add" onclick="addRecord()">ğŸ¶ è¨˜ä¸€ç­†å¸³ï¼</button>
        </div>
    </div>

    <!-- åœ–è¡¨å€ -->
    <div class="card">
        <h2>ğŸ“Š æ”¯å‡ºæ¯”ä¾‹</h2>
        <div style="max-width: 250px; margin: 0 auto;">
            <canvas id="expenseChart"></canvas>
        </div>
    </div>

    <!-- æ­·å²ç´€éŒ„ -->
    <div class="card full-width">
        <h2>ğŸ“œ æ•£æ­¥è¶³è·¡</h2>
        <div id="history" class="history-list"></div>
        <button onclick="clearAll()" style="margin-top:10px; border:none; background:none; color:#999; cursor:pointer; text-decoration:underline;">æ¸…é™¤æ‰€æœ‰è³‡æ–™</button>
    </div>
</div>

<script>
    const apiKey = ""; // API Key æœƒç”±ç’°å¢ƒè‡ªå‹•æ³¨å…¥
    const STORAGE_KEY = 'smartspend_data_ai_v1';
    let records = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];

    // --- åœ–è¡¨åˆå§‹åŒ– ---
    const categories = ['é¤é£²', 'äº¤é€š', 'å¨›æ¨‚', 'å­¸ç¿’', 'è–ªæ°´', 'å…¶ä»–'];
    const ctx = document.getElementById('expenseChart').getContext('2d');
    const expenseChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: categories,
            datasets: [{
                data: new Array(6).fill(0),
                backgroundColor: ['#fbbf24', '#60a5fa', '#f472b6', '#34d399', '#10b981', '#cbd5e1']
            }]
        },
        options: { cutout: '70%', plugins: { legend: { position: 'bottom' } } }
    });

    window.onload = () => {
        const now = new Date();
        document.getElementById('record-date').value = now.toISOString().split('T')[0];
        initYearFilter(now.getFullYear());
        document.getElementById('month-filter').value = String(now.getMonth() + 1).padStart(2, '0');
        updateUI();
    };

    function initYearFilter(defaultYear) {
        const yearFilter = document.getElementById('year-filter');
        for (let y = 2100; y >= 2000; y--) {
            const opt = new Option(`${y} å¹´`, y);
            if (y === defaultYear) opt.selected = true;
            yearFilter.add(opt);
        }
    }

    // --- AI æ™ºæ…§è§£æé‚è¼¯ï¼šå«é‡è©¦æ©Ÿåˆ¶ ---
    async function processAI() {
        const input = document.getElementById('ai-input').value;
        const status = document.getElementById('ai-status');
        const btn = document.getElementById('btn-ai');
        if (!input) return;

        btn.disabled = true;
        status.innerText = "æ±ªæ±ªï¼æ­£åœ¨å‹•è…¦è§£æä¸­...";
        
        const systemPrompt = `ä½ æ˜¯ä¸€å€‹å°ˆæ¥­çš„è¨˜å¸³åŠ©ç†ã€Œé˜¿æŸ´ã€ã€‚è«‹è§£æä½¿ç”¨è€…çš„å¥å­ä¸¦è½‰æ›ç‚º JSON æ ¼å¼ã€‚
        ä»Šå¤©çš„æ—¥æœŸæ˜¯ ${new Date().toISOString().split('T')[0]}ã€‚
        é¡åˆ¥å¿…é ˆæ˜¯ï¼šé¤é£², äº¤é€š, å¨›æ¨‚, å­¸ç¿’, è–ªæ°´, å…¶ä»– ä¹‹ä¸€ã€‚
        é¡å‹å¿…é ˆæ˜¯ï¼šæ”¯å‡º, æ”¶å…¥ ä¹‹ä¸€ã€‚
        è¼¸å‡ºæ ¼å¼ç¯„ä¾‹ï¼š{"date": "YYYY-MM-DD", "type": "æ”¯å‡º", "category": "é¤é£²", "desc": "æ‹‰éºµ", "amount": 200}`;

        // æŒ‡æ•¸å°é€€é‡è©¦æ©Ÿåˆ¶
        const maxRetries = 5;
        const delays = [1000, 2000, 4000, 8000, 16000];
        
        const callGemini = async () => {
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    contents: [{ parts: [{ text: input }] }],
                    systemInstruction: { parts: [{ text: systemPrompt }] },
                    generationConfig: { responseMimeType: "application/json" }
                })
            });
            if (!response.ok) throw new Error(`HTTP Error: ${response.status}`);
            return await response.json();
        };

        let lastError = null;
        for (let i = 0; i <= maxRetries; i++) {
            try {
                const result = await callGemini();
                const data = JSON.parse(result.candidates[0].content.parts[0].text);
                
                // è‡ªå‹•å¸¶å…¥è§£æçµæœ
                document.getElementById('record-date').value = data.date;
                document.getElementById('desc').value = data.desc;
                document.getElementById('amount').value = data.amount;
                document.getElementById('category').value = data.category;
                if (data.type === 'æ”¶å…¥') document.getElementById('type-income').checked = true;
                else document.getElementById('type-expense').checked = true;

                status.innerText = `æ±ªï¼è§£ææˆåŠŸï¼š${data.desc} $${data.amount}ã€‚è«‹ç¢ºèªå¾Œé»æ“Šæ–°å¢ï¼`;
                document.getElementById('ai-input').value = "";
                btn.disabled = false;
                return; // æˆåŠŸå¾Œé€€å‡ºå¾ªç’°
            } catch (error) {
                lastError = error;
                if (i < maxRetries) {
                    status.innerText = `æ±ª...å—…è¦ºå¤±éˆï¼Œç¬¬ ${i+1} æ¬¡é‡è©¦ä¸­...`;
                    await new Promise(resolve => setTimeout(resolve, delays[i]));
                }
            }
        }

        // æ‰€æœ‰é‡è©¦å‡å¤±æ•—
        status.innerText = "æ±ªå—š...è§£æå¤±æ•—ï¼Œè«‹å†èªªæ¸…æ¥šä¸€é»ã€‚";
        console.error("AI æœ€çµ‚è™•ç†å¤±æ•—:", lastError);
        btn.disabled = false;
    }

    // --- åŸºç¤è¨˜å¸³åŠŸèƒ½ ---
    function addRecord() {
        const date = document.getElementById('record-date').value;
        const desc = document.getElementById('desc').value;
        const amount = parseInt(document.getElementById('amount').value);
        const category = document.getElementById('category').value;
        const type = document.querySelector('input[name="type"]:checked').value;

        if (!date || !desc || isNaN(amount)) return alert("è³‡æ–™ä¸å®Œæ•´ï¼");

        records.push({ id: Date.now(), date, desc, amount, category, type });
        localStorage.setItem(STORAGE_KEY, JSON.stringify(records));
        updateUI();
        
        // æ¸…ç©ºè¼¸å…¥
        document.getElementById('desc').value = '';
        document.getElementById('amount').value = '';
        document.getElementById('ai-status').innerText = "è¨˜å¸³æˆåŠŸï¼æ±ªï¼";
    }

    function updateUI() {
        const year = document.getElementById('year-filter').value;
        const month = document.getElementById('month-filter').value;
        const prefix = `${year}-${month}`;
        
        const historyDiv = document.getElementById('history');
        historyDiv.innerHTML = '';
        
        let inc = 0, exp = 0;
        let catTotals = new Array(6).fill(0);

        const filtered = records.filter(r => r.date.startsWith(prefix))
                               .sort((a,b) => b.date.localeCompare(a.date));

        filtered.forEach(r => {
            const isInc = r.type === 'æ”¶å…¥';
            if (isInc) inc += r.amount;
            else {
                exp += r.amount;
                const idx = categories.indexOf(r.category);
                if (idx !== -1) catTotals[idx] += r.amount;
            }

            const item = document.createElement('div');
            item.className = `history-item ${isInc ? 'item-income' : 'item-expense'}`;
            item.innerHTML = `
                <div><small>${r.date}</small><br><strong>${r.category} | ${r.desc}</strong></div>
                <div class="amount">${isInc ? '+' : '-'}$${r.amount}</div>
            `;
            historyDiv.appendChild(item);
        });

        document.getElementById('total-income').innerText = `$${inc}`;
        document.getElementById('total-expense').innerText = `$${exp}`;
        document.getElementById('total-balance').innerText = `$${inc - exp}`;
        
        expenseChart.data.datasets[0].data = catTotals;
        expenseChart.update();
        
        checkGrowth(inc, exp);
    }

    function checkGrowth(inc, exp) {
        const uniqueDays = new Set(records.map(r => r.date)).size;
        const savingsRate = inc > 0 ? (inc - exp) / inc : 0;
        
        const sunglass = document.getElementById('acc-sunglasses');
        const crown = document.getElementById('acc-crown');
        
        if (uniqueDays >= 3) sunglass.classList.add('unlocked');
        if (savingsRate >= 0.5 && inc > 0) crown.classList.add('unlocked');
    }

    function clearAll() {
        if (confirm("ç¢ºå®šæ¸…é™¤ï¼Ÿ")) { records = []; localStorage.removeItem(STORAGE_KEY); updateUI(); }
    }
</script>
</body>
</html>