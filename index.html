<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SmartSpend | èŒå¯µæ”¶æ”¯å„€è¡¨æ¿ (æ™‚é–“æœˆä»½ç‰ˆ)</title>
    <!-- å¼•å…¥å¤–éƒ¨å‡½å¼åº« -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        :root {
            --primary: #d97706; /* æŸ´çŠ¬é‡‘ */
            --secondary: #fef3c7;
            --accent: #f472b6; /* è‚‰çƒç²‰ */
            --success: #10b981;
            --danger: #ef4444;
            --bg: #fffcf2;
        }

        body {
            font-family: 'PingFang TC', 'Microsoft JhengHei', sans-serif;
            background-color: var(--bg);
            margin: 0;
            padding: 20px;
            color: #451a03;
            background-image: radial-gradient(#fbbf24 0.5px, transparent 0.5px);
            background-size: 20px 20px;
        }

        .dashboard {
            max-width: 900px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
        }

        .card {
            background: rgba(255, 255, 255, 0.9);
            padding: 30px;
            border-radius: 24px;
            box-shadow: 0 10px 25px -5px rgba(217, 119, 6, 0.1);
            border: 2px solid #fde68a;
            position: relative;
            overflow: hidden;
        }

        .full-width { grid-column: 1 / -1; }

        /* æ¨™é¡Œç½®ä¸­è¨­å®š */
        h1 { 
            margin-top: 0; 
            color: var(--primary); 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            gap: 10px; 
            text-align: center;
        }

        h2 { 
            margin-top: 0; 
            color: var(--primary); 
            display: flex; 
            align-items: center; 
            gap: 10px; 
        }

        /* æ”¶æ”¯åˆ‡æ›é–‹é—œ */
        .type-toggle {
            display: flex;
            background: #f1f5f9;
            padding: 5px;
            border-radius: 12px;
            margin-bottom: 15px;
        }

        .type-toggle label {
            flex: 1;
            text-align: center;
            padding: 10px;
            cursor: pointer;
            border-radius: 8px;
            font-weight: bold;
            transition: all 0.3s;
        }

        .type-toggle input { display: none; }
        
        #type-expense:checked + label { background: var(--danger); color: white; }
        #type-income:checked + label { background: var(--success); color: white; }

        .input-group {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        input, select {
            padding: 14px;
            border: 2px solid #fde68a;
            border-radius: 12px;
            font-size: 16px;
            outline: none;
            transition: border-color 0.2s;
        }

        input:focus, select:focus {
            border-color: var(--primary);
        }

        button {
            padding: 14px;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 700;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-add { background: var(--primary); color: white; box-shadow: 0 4px 0 #b45309; }
        .btn-add:active { transform: translateY(2px); box-shadow: 0 2px 0 #b45309; }
        
        .btn-export { background: #64748b; color: white; margin-top: 15px; }

        /* çµ±è¨ˆæ•¸å­— */
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .summary-item {
            text-align: center;
            padding: 15px;
            background: white;
            border-radius: 15px;
            border: 1px solid #fde68a;
        }

        .summary-label { font-size: 12px; color: #64748b; margin-bottom: 5px; }
        .summary-value { font-size: 1.2rem; font-weight: bold; }
        .val-income { color: var(--success); }
        .val-expense { color: var(--danger); }
        .val-balance { color: var(--primary); }

        /* ç¯©é¸å™¨æ¨£å¼ */
        .filter-container {
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .history-list {
            max-height: 350px;
            overflow-y: auto;
            margin-top: 15px;
            padding-right: 5px;
        }

        .history-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            border-radius: 12px;
            margin-bottom: 8px;
            background: #fff;
            border-left: 8px solid #ccc;
        }

        .item-income { border-left-color: var(--success); }
        .item-expense { border-left-color: var(--danger); }

        .item-info { display: flex; flex-direction: column; }
        .item-date { font-size: 11px; color: #94a3b8; }

        .amount { font-weight: bold; font-size: 1.1rem; }
        .amt-income { color: var(--success); }
        .amt-expense { color: var(--danger); }

        .dog-badge {
            position: absolute;
            top: -10px;
            right: -10px;
            font-size: 4rem;
            opacity: 0.1;
            pointer-events: none;
        }

        @media (max-width: 768px) {
            .dashboard { grid-template-columns: 1fr; }
            .summary-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

<div class="dashboard">
    <!-- æ¨™é¡Œå€ -->
    <div class="card full-width" style="text-align: center; background: linear-gradient(135deg, #fffbeb 0%, #fff 100%);">
        <span style="font-size: 3rem;">ğŸ•</span>
        <h1>SmartSpend èŒå¯µè¨˜å¸³å„€è¡¨æ¿</h1>
        <p>æ±ªï¼ä¸ç®¡æ˜¯è³ºåˆ°çš„è‚‰è‚‰é‚„æ˜¯èŠ±æ‰çš„éª¨é ­éƒ½è¦è¨˜æ¸…æ¥šå–”ï¼ğŸ¾</p>
    </div>

    <!-- çµé¤˜çµ±è¨ˆå€ -->
    <div class="card full-width">
        <div class="filter-container">
            <label for="month-filter">ğŸ“… æŸ¥çœ‹æœˆä»½ï¼š</label>
            <select id="month-filter" onchange="updateUI()">
                <!-- ç”± JS å‹•æ…‹ç”Ÿæˆ -->
            </select>
        </div>
        <div class="summary-grid">
            <div class="summary-item">
                <div class="summary-label">ç•¶æœˆæ”¶å…¥ ğŸ’°</div>
                <div id="total-income" class="summary-value val-income">$0</div>
            </div>
            <div class="summary-item">
                <div class="summary-label">ç•¶æœˆæ”¯å‡º ğŸ’¸</div>
                <div id="total-expense" class="summary-value val-expense">$0</div>
            </div>
            <div class="summary-item">
                <div class="summary-label">ç•¶æœˆçµé¤˜ ğŸ¦´</div>
                <div id="total-balance" class="summary-value val-balance">$0</div>
            </div>
        </div>
    </div>

    <!-- è¼¸å…¥å€ -->
    <div class="card">
        <div class="dog-badge">ğŸ¦´</div>
        <h2>â• æ–°å¢ç´€éŒ„</h2>
        <div class="input-group">
            <div class="type-toggle">
                <input type="radio" name="type" id="type-expense" value="æ”¯å‡º" checked>
                <label for="type-expense">ğŸ’¸ æ”¯å‡º</label>
                <input type="radio" name="type" id="type-income" value="æ”¶å…¥">
                <label for="type-income">ğŸ’° æ”¶å…¥</label>
            </div>
            <input type="date" id="record-date">
            <input type="text" id="desc" placeholder="é …ç›®çš„åç¨±...">
            <input type="number" id="amount" placeholder="é‡‘é¡ (éª¨é ­)">
            <select id="category">
                <option value="é¤é£²">ğŸ± ç¾é£Ÿé¤é£²</option>
                <option value="äº¤é€š">ğŸš— æ±ªæ±ªå‡ºé–€</option>
                <option value="å¨›æ¨‚">ğŸ® ç©è€ç©å…·</option>
                <option value="å­¸ç¿’">ğŸ“š å­¸ç¿’æˆé•·</option>
                <option value="è–ªæ°´">ğŸ’µ å‹å‹•æ‰€å¾—</option>
                <option value="å…¶ä»–">âœ¨ å…¶ä»–é …ç›®</option>
            </select>
            <button class="btn-add" onclick="addRecord()">ğŸ¶ è¨˜ä¸€ç­†å¸³ï¼</button>
        </div>
    </div>

    <!-- åœ–è¡¨åˆ†æå€ -->
    <div class="card">
        <div class="dog-badge">ğŸ¾</div>
        <h2>ğŸ“Š ç•¶æœˆæ”¯å‡ºæ¯”ä¾‹</h2>
        <div style="max-width: 280px; margin: 0 auto;">
            <canvas id="expenseChart"></canvas>
        </div>
    </div>

    <!-- æ­·å²ç´€éŒ„å€ -->
    <div class="card full-width">
        <div class="dog-badge">ğŸ¾</div>
        <h2>ğŸ“œ æ•£æ­¥è¶³è·¡ (æœ¬åœ°æ¶ˆè²»ç´€éŒ„)</h2>
        <div id="history" class="history-list">
            <!-- å‹•æ…‹æ’å…¥ -->
        </div>
        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
            <button class="btn-export" onclick="exportCSV()">ğŸ“¥ åŒ¯å‡ºæˆæœå ±å‘Š</button>
            <button onclick="clearAll()" style="background:none; color: #94a3b8; font-size: 12px; cursor: pointer; border: none; text-decoration: underline;">åŸ‹æ‰æ‰€æœ‰ç´€éŒ„ (é‡ç½®)</button>
        </div>
    </div>
</div>

<script>
    // --- 1. è³‡æ–™ç®¡ç† ---
    const STORAGE_KEY = 'smartspend_data_v3';
    let records = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];

    // --- 2. Chart.js åˆå§‹åŒ– ---
    const ctx = document.getElementById('expenseChart').getContext('2d');
    const categories = ['é¤é£²', 'äº¤é€š', 'å¨›æ¨‚', 'å­¸ç¿’', 'è–ªæ°´', 'å…¶ä»–'];

    const expenseChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: categories,
            datasets: [{
                data: new Array(categories.length).fill(0),
                backgroundColor: ['#fbbf24', '#60a5fa', '#f472b6', '#34d399', '#10b981', '#cbd5e1'],
                hoverOffset: 15,
                borderRadius: 5
            }]
        },
        options: {
            cutout: '65%',
            plugins: { 
                legend: { position: 'bottom', labels: { usePointStyle: true, font: { weight: 'bold' } } } 
            }
        }
    });

    window.onload = () => {
        // è¨­å®šé è¨­æ—¥æœŸç‚ºä»Šå¤©
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('record-date').value = today;
        
        initMonthFilter();
        updateUI();
    };

    function initMonthFilter() {
        const filter = document.getElementById('month-filter');
        const now = new Date();
        const currentYM = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
        
        // é è¨­æä¾›æœ€è¿‘ 6 å€‹æœˆ
        filter.innerHTML = '';
        for (let i = 0; i < 6; i++) {
            const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
            const ym = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
            const option = document.createElement('option');
            option.value = ym;
            option.textContent = `${d.getFullYear()}å¹´ ${d.getMonth() + 1}æœˆ`;
            filter.appendChild(option);
        }
    }

    // --- 3. æ ¸å¿ƒé‚è¼¯ ---
    function addRecord() {
        const date = document.getElementById('record-date').value;
        const desc = document.getElementById('desc').value;
        const amount = parseInt(document.getElementById('amount').value);
        const category = document.getElementById('category').value;
        const type = document.querySelector('input[name="type"]:checked').value;

        if (!date || !desc || isNaN(amount)) {
            alert("æ±ªï¼æ—¥æœŸã€é …ç›®å’Œé‡‘é¡éƒ½è¦å¡«å¥½å–”ï¼");
            return;
        }

        const newRecord = {
            id: Date.now(),
            date, // ä½¿ç”¨é¸å®šçš„æ—¥æœŸ "YYYY-MM-DD"
            desc,
            amount,
            category,
            type,
            timestamp: new Date(date).getTime()
        };

        records.push(newRecord);
        saveData();
        
        // å¦‚æœæ–°å¢çš„æ—¥æœŸä¸åœ¨ç›®å‰çš„ç¯©é¸æœˆä»½ä¸­ï¼Œæç¤ºä½¿ç”¨è€…
        const selectedMonth = document.getElementById('month-filter').value;
        if (!date.startsWith(selectedMonth)) {
            alert("æ±ªï¼ç´€éŒ„å·²å„²å­˜ï¼Œä½†ç›®å‰æ­£åœ¨æŸ¥çœ‹ä¸åŒæœˆä»½ï¼Œè«‹åˆ‡æ›æœˆä»½æŸ¥çœ‹ã€‚");
        }
        
        updateUI();

        document.getElementById('desc').value = '';
        document.getElementById('amount').value = '';
    }

    function saveData() {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(records));
    }

    function updateUI() {
        const historyDiv = document.getElementById('history');
        const selectedMonth = document.getElementById('month-filter').value; // æ ¼å¼: "YYYY-MM"
        historyDiv.innerHTML = '';
        
        let incomeTotal = 0;
        let expenseTotal = 0;
        let categoryExpenseTotals = new Array(categories.length).fill(0);

        // ç¯©é¸é¸å®šæœˆä»½çš„ç´€éŒ„
        const filteredRecords = records.filter(r => r.date.startsWith(selectedMonth));

        if (filteredRecords.length > 0) {
            // æŒ‰æ—¥æœŸæ’åº (ç”±æ–°åˆ°èˆŠ)
            const sortedRecords = [...filteredRecords].sort((a, b) => b.date.localeCompare(a.date) || b.id - a.id);
            
            sortedRecords.forEach(item => {
                const isIncome = item.type === 'æ”¶å…¥';
                if (isIncome) incomeTotal += item.amount;
                else expenseTotal += item.amount;

                const div = document.createElement('div');
                div.className = `history-item ${isIncome ? 'item-income' : 'item-expense'}`;
                div.innerHTML = `
                    <span class="item-info">
                        <span class="item-date">${item.date}</span>
                        <strong>ğŸ¾ [${item.type}] ${item.category}</strong>
                        <small style="color:#64748b">${item.desc}</small>
                    </span>
                    <span class="amount ${isIncome ? 'amt-income' : 'amt-expense'}">
                        ${isIncome ? '+' : '-'}$${item.amount}
                    </span>
                `;
                historyDiv.appendChild(div);

                if (!isIncome) {
                    const idx = categories.indexOf(item.category);
                    if (idx !== -1) categoryExpenseTotals[idx] += item.amount;
                }
            });
        } else {
            historyDiv.innerHTML = `<p style="text-align: center; color: #94a3b8;">æ±ªï¼${selectedMonth} é‚„æ²’æœ‰ç´€éŒ„å–”...</p>`;
        }

        // æ›´æ–°çµ±è¨ˆæ•¸å­—
        document.getElementById('total-income').innerText = `$${incomeTotal}`;
        document.getElementById('total-expense').innerText = `$${expenseTotal}`;
        document.getElementById('total-balance').innerText = `$${incomeTotal - expenseTotal}`;

        // æ›´æ–°åœ–è¡¨
        expenseChart.data.datasets[0].data = categoryExpenseTotals;
        expenseChart.update();
    }

    // --- 4. åŠŸèƒ½æ€§å·¥å…· ---
    function exportCSV() {
        if (records.length === 0) {
            alert("é‚„æ²’æœ‰éª¨é ­ç´€éŒ„å¯ä»¥åŒ¯å‡ºå–”ï¼");
            return;
        }
        let csvContent = "æ—¥æœŸ,é¡å‹,é¡åˆ¥,é …ç›®,é‡‘é¡\n";
        records.sort((a,b) => a.date.localeCompare(b.date)).forEach(r => {
            csvContent += `${r.date},${r.type},${r.category},${r.desc},${r.amount}\n`;
        });
        const blob = new Blob(["\ufeff" + csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = "èŒå¯µæ”¶æ”¯å®Œæ•´å ±å‘Š.csv";
        link.click();
    }

    function clearAll() {
        if (confirm("æ±ªï¼ç¢ºå®šè¦æŠŠè¾›è‹¦è¨˜åœ¨é›»è…¦è£¡çš„ã€Œæ‰€æœ‰æœˆä»½ã€å¸³éƒ½åŸ‹æ‰å—ï¼Ÿ")) {
            records = [];
            saveData();
            updateUI();
        }
    }
</script>

</body>
</html>