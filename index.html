<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SmartSpend | èŒå¯µè¨˜å¸³å„€è¡¨æ¿ (æœ¬åœ°å„²å­˜ç‰ˆ)</title>
    <!-- å¼•å…¥å¤–éƒ¨å‡½å¼åº« -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        :root {
            --primary: #d97706; /* æŸ´çŠ¬é‡‘ */
            --secondary: #fef3c7;
            --accent: #f472b6; /* è‚‰çƒç²‰ */
            --success: #10b981;
            --danger: #ef4444;
            --bg: #fffcf2;
        }

        body {
            font-family: 'PingFang TC', 'Microsoft JhengHei', sans-serif;
            background-color: var(--bg);
            margin: 0;
            padding: 20px;
            color: #451a03;
            background-image: radial-gradient(#fbbf24 0.5px, transparent 0.5px);
            background-size: 20px 20px;
        }

        .dashboard {
            max-width: 900px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
        }

        .card {
            background: rgba(255, 255, 255, 0.9);
            padding: 30px;
            border-radius: 24px;
            box-shadow: 0 10px 25px -5px rgba(217, 119, 6, 0.1);
            border: 2px solid #fde68a;
            position: relative;
            overflow: hidden;
        }

        .full-width { grid-column: 1 / -1; }

        h1, h2 { margin-top: 0; color: var(--primary); display: flex; align-items: center; gap: 10px; }

        .input-group {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        input, select {
            padding: 14px;
            border: 2px solid #fde68a;
            border-radius: 12px;
            font-size: 16px;
            outline: none;
            transition: border-color 0.2s;
        }

        input:focus, select:focus {
            border-color: var(--primary);
        }

        button {
            padding: 14px;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 700;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-add { background: var(--primary); color: white; box-shadow: 0 4px 0 #b45309; }
        .btn-add:active { transform: translateY(2px); box-shadow: 0 2px 0 #b45309; }
        
        .btn-export { background: var(--success); color: white; margin-top: 15px; }

        .history-list {
            max-height: 350px;
            overflow-y: auto;
            margin-top: 15px;
            padding-right: 5px;
        }

        .history-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            border-radius: 12px;
            margin-bottom: 8px;
            background: #fff;
            border-left: 5px solid var(--secondary);
        }

        .amount { font-weight: bold; color: var(--danger); font-size: 1.1rem; }

        .dog-badge {
            position: absolute;
            top: -10px;
            right: -10px;
            font-size: 4rem;
            opacity: 0.1;
            pointer-events: none;
        }

        @media (max-width: 768px) {
            .dashboard { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

<div class="dashboard">
    <!-- æ¨™é¡Œå€ -->
    <div class="card full-width" style="text-align: center; background: linear-gradient(135deg, #fffbeb 0%, #fff 100%);">
        <h1>ğŸ•SmartSpend èŒå¯µè¨˜å¸³å„€è¡¨æ¿</h1>
        <p>æ±ªï¼è³‡æ–™ç¾åœ¨æœƒå­˜åœ¨ä½ çš„é›»è…¦è£¡ï¼Œä¸ç”¨æ“”å¿ƒç¶²è·¯å–”ï¼ğŸ¾</p>
    </div>

    <!-- è¼¸å…¥å€ -->
    <div class="card">
        <div class="dog-badge">ğŸ¦´</div>
        <h2>â• æ–°å¢å°ç‹—é–‹éŠ·</h2>
        <div class="input-group">
            <input type="text" id="desc" placeholder="åƒäº†ä»€éº¼æˆ–è²·äº†ä»€éº¼ï¼Ÿ">
            <input type="number" id="amount" placeholder="é‡‘é¡ (éª¨é ­)">
            <select id="category">
                <option value="é¤é£²">ğŸ± ç¾é£Ÿé¤é£²</option>
                <option value="äº¤é€š">ğŸš— æ±ªæ±ªå‡ºé–€</option>
                <option value="å¨›æ¨‚">ğŸ® ç©è€ç©å…·</option>
                <option value="è³¼ç‰©">ğŸ›ï¸ è²·è²·æ±è¥¿</option>
                <option value="å…¶ä»–">âœ¨ å…¶ä»–é›œé …</option>
            </select>
            <button class="btn-add" onclick="addRecord()">ğŸ¶ è¨˜ä¸€ç­†å¸³ï¼</button>
        </div>
    </div>

    <!-- åœ–è¡¨åˆ†æå€ -->
    <div class="card">
        <div class="dog-badge">ğŸ¾</div>
        <h2>ğŸ“Š éª¨é ­å»å“ªäº†ï¼Ÿ</h2>
        <div style="max-width: 280px; margin: 0 auto;">
            <canvas id="expenseChart"></canvas>
        </div>
    </div>

    <!-- æ­·å²ç´€éŒ„å€ -->
    <div class="card full-width">
        <div class="dog-badge">ğŸ¾</div>
        <h2>ğŸ“œ æ•£æ­¥è¶³è·¡ (æœ¬åœ°æ¶ˆè²»ç´€éŒ„)</h2>
        <div id="history" class="history-list">
            <!-- å‹•æ…‹æ’å…¥ -->
        </div>
        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
            <button class="btn-export" onclick="exportCSV()">ğŸ“¥ åŒ¯å‡ºæˆæœå ±å‘Š</button>
            <button onclick="clearAll()" style="background:none; color: #94a3b8; font-size: 12px; cursor: pointer; border: none; text-decoration: underline;">åŸ‹æ‰æ‰€æœ‰ç´€éŒ„ (é‡ç½®)</button>
        </div>
    </div>
</div>

<script>
    // --- 1. è³‡æ–™ç®¡ç† (ä½¿ç”¨ localStorage æ›¿ä»£ Firebase) ---
    const STORAGE_KEY = 'smartspend_data';
    let records = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];

    // --- 2. Chart.js åˆå§‹åŒ– ---
    const ctx = document.getElementById('expenseChart').getContext('2d');
    const categories = ['é¤é£²', 'äº¤é€š', 'å¨›æ¨‚', 'è³¼ç‰©', 'å…¶ä»–'];

    const expenseChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: categories,
            datasets: [{
                data: [0, 0, 0, 0, 0],
                backgroundColor: ['#fbbf24', '#60a5fa', '#f472b6', '#a78bfa', '#cbd5e1'],
                hoverOffset: 15,
                borderRadius: 5
            }]
        },
        options: {
            cutout: '65%',
            plugins: { 
                legend: { position: 'bottom', labels: { usePointStyle: true, font: { weight: 'bold' } } } 
            }
        }
    });

    // åˆå§‹è¼‰å…¥ä»‹é¢
    window.onload = () => {
        updateUI();
    };

    // --- 3. æ ¸å¿ƒé‚è¼¯ ---
    function addRecord() {
        const desc = document.getElementById('desc').value;
        const amount = parseInt(document.getElementById('amount').value);
        const category = document.getElementById('category').value;

        if (!desc || isNaN(amount)) {
            alert("æ±ªï¼è«‹å¯«æ¸…æ¥šé …ç›®å’Œé‡‘é¡å–”ï¼");
            return;
        }

        const newRecord = {
            id: Date.now(),
            desc,
            amount,
            category,
            timestamp: Date.now()
        };

        // å­˜å…¥é™£åˆ—ä¸¦æ›´æ–° localStorage
        records.push(newRecord);
        saveData();
        
        // æ›´æ–°ä»‹é¢
        updateUI();

        // æ¸…ç©ºè¼¸å…¥
        document.getElementById('desc').value = '';
        document.getElementById('amount').value = '';
    }

    function saveData() {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(records));
    }

    function updateUI() {
        const historyDiv = document.getElementById('history');
        historyDiv.innerHTML = '';
        
        let newTotals = [0, 0, 0, 0, 0];

        if (records.length > 0) {
            // æŒ‰æ™‚é–“ç”±æ–°åˆ°èˆŠæ’åº
            const sortedRecords = [...records].sort((a, b) => b.timestamp - a.timestamp);
            
            sortedRecords.forEach(item => {
                const div = document.createElement('div');
                div.className = 'history-item';
                div.innerHTML = `
                    <span><strong>ğŸ¾ ${item.category}</strong> | ${item.desc}</span>
                    <span class="amount">$${item.amount}</span>
                `;
                historyDiv.appendChild(div);

                const idx = categories.indexOf(item.category);
                if (idx !== -1) newTotals[idx] += item.amount;
            });
        } else {
            historyDiv.innerHTML = '<p style="text-align: center; color: #94a3b8;">æ±ªï¼ç›®å‰é‚„æ²’æœ‰ç´€éŒ„å–”...</p>';
        }

        // æ›´æ–°åœ–è¡¨
        expenseChart.data.datasets[0].data = newTotals;
        expenseChart.update();
    }

    // --- 4. CSV å°å‡º ---
    function exportCSV() {
        if (records.length === 0) {
            alert("é‚„æ²’æœ‰éª¨é ­ç´€éŒ„å¯ä»¥åŒ¯å‡ºå–”ï¼");
            return;
        }

        let csvContent = "æ™‚é–“,é¡åˆ¥,é …ç›®,é‡‘é¡\n";
        records.forEach(r => {
            const date = new Date(r.timestamp).toLocaleDateString();
            csvContent += `${date},${r.category},${r.desc},${r.amount}\n`;
        });

        const blob = new Blob(["\ufeff" + csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = "èŒå¯µè¨˜å¸³å ±å‘Š_æœ¬åœ°å‚™ä»½.csv";
        link.click();
    }

    function clearAll() {
        if (confirm("æ±ªï¼ç¢ºå®šè¦æŠŠè¾›è‹¦è¨˜åœ¨é›»è…¦è£¡çš„å¸³éƒ½åŸ‹æ‰å—ï¼Ÿ")) {
            records = [];
            saveData();
            updateUI();
        }
    }
</script>

</body>
</html>