<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SmartSpend | èŒå¯µæ”¶æ”¯å„€è¡¨æ¿ (2000-2100 ç‰ˆ)</title>
    <!-- å¼•å…¥å¤–éƒ¨å‡½å¼åº« -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        :root {
            --primary: #d97706; /* æŸ´çŠ¬é‡‘ */
            --secondary: #fef3c7;
            --accent: #f472b6; /* è‚‰çƒç²‰ */
            --success: #10b981;
            --danger: #ef4444;
            --bg: #fffcf2;
        }

        body {
            font-family: 'PingFang TC', 'Microsoft JhengHei', sans-serif;
            background-color: var(--bg);
            margin: 0;
            padding: 20px;
            color: #451a03;
            background-image: radial-gradient(#fbbf24 0.5px, transparent 0.5px);
            background-size: 20px 20px;
        }

        .dashboard {
            max-width: 900px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
        }

        .card {
            background: rgba(255, 255, 255, 0.9);
            padding: 30px;
            border-radius: 24px;
            box-shadow: 0 10px 25px -5px rgba(217, 119, 6, 0.1);
            border: 2px solid #fde68a;
            position: relative;
            overflow: hidden;
        }

        .full-width { grid-column: 1 / -1; }

        /* --- é˜¿æŸ´æˆé•·ç³»çµ±æ¨£å¼ --- */
        .pet-container {
            position: relative;
            width: 150px;
            height: 150px;
            margin: 0 auto 10px;
            background: white;
            border-radius: 50%;
            border: 4px solid var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 5rem;
        }

        .accessory {
            position: absolute;
            font-size: 2.5rem;
            transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            opacity: 0;
            transform: scale(0.5) translateY(20px);
        }

        .accessory.unlocked {
            opacity: 1;
            transform: scale(1) translateY(0);
        }

        #acc-sunglasses { top: 45px; left: 35px; font-size: 3rem; } /* å¢¨é¡ä½ç½® */
        #acc-crown { top: -20px; left: 45px; transform: rotate(-15deg) scale(0.5); } /* çš‡å† ä½ç½® */
        #acc-crown.unlocked { transform: rotate(-15deg) scale(1.2); }

        .growth-status {
            font-size: 0.9rem;
            background: var(--secondary);
            padding: 5px 15px;
            border-radius: 20px;
            display: inline-block;
            margin-top: 10px;
            font-weight: bold;
            color: var(--primary);
        }

        h1 { 
            margin: 10px 0; 
            color: var(--primary); 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            gap: 10px; 
            text-align: center;
        }
        /* --- çµæŸ --- */

        h2 { 
            margin-top: 0; 
            color: var(--primary); 
            display: flex; 
            align-items: center; 
            gap: 10px; 
        }

        .type-toggle {
            display: flex;
            background: #f1f5f9;
            padding: 5px;
            border-radius: 12px;
            margin-bottom: 15px;
        }

        .type-toggle label {
            flex: 1;
            text-align: center;
            padding: 10px;
            cursor: pointer;
            border-radius: 8px;
            font-weight: bold;
            transition: all 0.3s;
        }

        .type-toggle input { display: none; }
        #type-expense:checked + label { background: var(--danger); color: white; }
        #type-income:checked + label { background: var(--success); color: white; }

        .input-group {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        input, select {
            padding: 14px;
            border: 2px solid #fde68a;
            border-radius: 12px;
            font-size: 16px;
            outline: none;
            transition: border-color 0.2s;
        }

        input:focus, select:focus {
            border-color: var(--primary);
        }

        button {
            padding: 14px;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 700;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-add { background: var(--primary); color: white; box-shadow: 0 4px 0 #b45309; }
        .btn-add:active { transform: translateY(2px); box-shadow: 0 2px 0 #b45309; }
        
        .btn-export { background: #64748b; color: white; margin-top: 15px; }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .summary-item {
            text-align: center;
            padding: 15px;
            background: white;
            border-radius: 15px;
            border: 1px solid #fde68a;
        }

        .summary-label { font-size: 12px; color: #64748b; margin-bottom: 5px; }
        .summary-value { font-size: 1.2rem; font-weight: bold; }
        .val-income { color: var(--success); }
        .val-expense { color: var(--danger); }
        .val-balance { color: var(--primary); }

        .filter-container {
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
            background: #fffbeb;
            padding: 10px 15px;
            border-radius: 15px;
        }

        .filter-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .history-list {
            max-height: 350px;
            overflow-y: auto;
            margin-top: 15px;
            padding-right: 5px;
        }

        .history-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            border-radius: 12px;
            margin-bottom: 8px;
            background: #fff;
            border-left: 8px solid #ccc;
        }

        .item-income { border-left-color: var(--success); }
        .item-expense { border-left-color: var(--danger); }

        .item-info { display: flex; flex-direction: column; }
        .item-date { font-size: 11px; color: #94a3b8; }

        .amount { font-weight: bold; font-size: 1.1rem; }
        .amt-income { color: var(--success); }
        .amt-expense { color: var(--danger); }

        .dog-badge {
            position: absolute;
            top: -10px;
            right: -10px;
            font-size: 4rem;
            opacity: 0.1;
            pointer-events: none;
        }

        @media (max-width: 768px) {
            .dashboard { grid-template-columns: 1fr; }
            .summary-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

<div class="dashboard">
    <!-- é˜¿æŸ´æˆé•·å®¤ -->
    <div class="card full-width" style="text-align: center; background: linear-gradient(135deg, #fffbeb 0%, #fff 100%);">
        <div class="pet-container">
            <span id="pet-main">ğŸ•</span>
            <!-- é…ä»¶å±¤ -->
            <span id="acc-sunglasses" class="accessory">ğŸ•¶ï¸</span>
            <span id="acc-crown" class="accessory">ğŸ‘‘</span>
        </div>
        <h1>SmartSpend èŒå¯µæˆé•·å®¤</h1>
        <div id="growth-text" class="growth-status">æ±ªï¼å¿«å»è¨˜å¸³è®“æˆ‘è®Šé…·ï¼ğŸ¾</div>
        <p style="font-size: 13px; color: #b45309; margin-top: 5px;">
            æˆå°±è§£é–æ¢ä»¶ï¼šğŸ•¶ï¸ ç´¯ç©è¨˜å¸³æ»¿ 3 å¤© | ğŸ‘‘ ç•¶æœˆå„²è“„ç‡é” 50%
        </p>
    </div>

    <!-- çµé¤˜çµ±è¨ˆå€èˆ‡å¹´æœˆç¯©é¸ -->
    <div class="card full-width">
        <div class="filter-container">
            <div class="filter-item">
                <label for="year-filter">ğŸ“… é¸æ“‡å¹´ä»½ï¼š</label>
                <select id="year-filter" onchange="updateUI()"></select>
            </div>
            <div class="filter-item">
                <label for="month-filter">æœˆä»½ï¼š</label>
                <select id="month-filter" onchange="updateUI()">
                    <option value="01">1æœˆ</option>
                    <option value="02">2æœˆ</option>
                    <option value="03">3æœˆ</option>
                    <option value="04">4æœˆ</option>
                    <option value="05">5æœˆ</option>
                    <option value="06">6æœˆ</option>
                    <option value="07">7æœˆ</option>
                    <option value="08">8æœˆ</option>
                    <option value="09">9æœˆ</option>
                    <option value="10">10æœˆ</option>
                    <option value="11">11æœˆ</option>
                    <option value="12">12æœˆ</option>
                </select>
            </div>
        </div>
        <div class="summary-grid">
            <div class="summary-item">
                <div class="summary-label">è©²æœˆç¸½æ”¶å…¥ ğŸ’°</div>
                <div id="total-income" class="summary-value val-income">$0</div>
            </div>
            <div class="summary-item">
                <div class="summary-label">è©²æœˆç¸½æ”¯å‡º ğŸ’¸</div>
                <div id="total-expense" class="summary-value val-expense">$0</div>
            </div>
            <div class="summary-item">
                <div class="summary-label">è©²æœˆçµé¤˜ ğŸ¦´</div>
                <div id="total-balance" class="summary-value val-balance">$0</div>
            </div>
        </div>
    </div>

    <!-- è¼¸å…¥å€ -->
    <div class="card">
        <div class="dog-badge">ğŸ¦´</div>
        <h2>â• æ–°å¢ç´€éŒ„</h2>
        <div class="input-group">
            <div class="type-toggle">
                <input type="radio" name="type" id="type-expense" value="æ”¯å‡º" checked>
                <label for="type-expense">ğŸ’¸ æ”¯å‡º</label>
                <input type="radio" name="type" id="type-income" value="æ”¶å…¥">
                <label for="type-income">ğŸ’° æ”¶å…¥</label>
            </div>
            <input type="date" id="record-date">
            <input type="text" id="desc" placeholder="é …ç›®çš„åç¨±...">
            <input type="number" id="amount" placeholder="é‡‘é¡ (éª¨é ­)">
            <select id="category">
                <option value="é¤é£²">ğŸ± ç¾é£Ÿé¤é£²</option>
                <option value="äº¤é€š">ğŸš— æ±ªæ±ªå‡ºé–€</option>
                <option value="å¨›æ¨‚">ğŸ® ç©è€ç©å…·</option>
                <option value="å­¸ç¿’">ğŸ“š å­¸ç¿’æˆé•·</option>
                <option value="è–ªæ°´">ğŸ’µ å‹å‹•æ‰€å¾—</option>
                <option value="å…¶ä»–">âœ¨ å…¶ä»–é …ç›®</option>
            </select>
            <button class="btn-add" onclick="addRecord()">ğŸ¶ è¨˜ä¸€ç­†å¸³ï¼</button>
        </div>
    </div>

    <!-- åœ–è¡¨åˆ†æå€ -->
    <div class="card">
        <div class="dog-badge">ğŸ¾</div>
        <h2>ğŸ“Š é¡åˆ¥æ”¯å‡ºæ¯”ä¾‹</h2>
        <div style="max-width: 280px; margin: 0 auto;">
            <canvas id="expenseChart"></canvas>
        </div>
    </div>

    <!-- æ­·å²ç´€éŒ„å€ -->
    <div class="card full-width">
        <div class="dog-badge">ğŸ¾</div>
        <h2>ğŸ“œ æ•£æ­¥è¶³è·¡ (æœ¬åœ°æ¶ˆè²»ç´€éŒ„)</h2>
        <div id="history" class="history-list"></div>
        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
            <button class="btn-export" onclick="exportCSV()">ğŸ“¥ åŒ¯å‡ºå®Œæ•´å ±è¡¨</button>
            <button onclick="clearAll()" style="background:none; color: #94a3b8; font-size: 12px; cursor: pointer; border: none; text-decoration: underline;">æ¸…é™¤æ‰€æœ‰è³‡æ–™</button>
        </div>
    </div>
</div>

<script>
    // --- 1. è³‡æ–™åº«åˆå§‹åŒ– ---
    const STORAGE_KEY = 'smartspend_data_v8';
    let records = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];

    // --- 2. Chart.js åˆå§‹åŒ– ---
    const ctx = document.getElementById('expenseChart').getContext('2d');
    const categories = ['é¤é£²', 'äº¤é€š', 'å¨›æ¨‚', 'å­¸ç¿’', 'è–ªæ°´', 'å…¶ä»–'];
    const expenseChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: categories,
            datasets: [{
                data: new Array(categories.length).fill(0),
                backgroundColor: ['#fbbf24', '#60a5fa', '#f472b6', '#34d399', '#10b981', '#cbd5e1'],
                hoverOffset: 15,
                borderRadius: 5
            }]
        },
        options: {
            cutout: '65%',
            plugins: { 
                legend: { position: 'bottom', labels: { usePointStyle: true, font: { weight: 'bold' } } } 
            }
        }
    });

    window.onload = () => {
        const now = new Date();
        document.getElementById('record-date').value = now.toISOString().split('T')[0];
        initYearFilter(now.getFullYear());
        document.getElementById('month-filter').value = String(now.getMonth() + 1).padStart(2, '0');
        updateUI();
    };

    function initYearFilter(defaultYear) {
        const yearFilter = document.getElementById('year-filter');
        yearFilter.innerHTML = '';
        for (let y = 2100; y >= 2000; y--) {
            const opt = document.createElement('option');
            opt.value = y;
            opt.textContent = `${y} å¹´`;
            if (y === defaultYear) opt.selected = true;
            yearFilter.appendChild(opt);
        }
    }

    // --- 3. éŠæˆ²åŒ–é‚è¼¯ï¼šæª¢æŸ¥é˜¿æŸ´æˆé•·ç‹€æ…‹ ---
    function checkGrowth(currentIncome, currentExpense) {
        // A. è¨ˆç®—ç¸½è¨˜å¸³å¤©æ•¸ (ä¸é‡è¤‡æ—¥æœŸ)
        const uniqueDays = new Set(records.map(r => r.date)).size;
        
        // B. è¨ˆç®—å„²è“„ç‡ (çµé¤˜ / æ”¶å…¥)
        const savingsRate = currentIncome > 0 ? (currentIncome - currentExpense) / currentIncome : 0;

        // æ›´æ–° UI é…ä»¶
        const accSunglasses = document.getElementById('acc-sunglasses');
        const accCrown = document.getElementById('acc-crown');
        const growthText = document.getElementById('growth-text');

        let statusMsg = `æ±ªï¼æˆ‘å·²ç¶“é™ªä½ æ•£æ­¥ ${uniqueDays} å¤©äº†ï¼`;

        // æ¢ä»¶ 1: æ»¿ 3 å¤©è§£é–å¢¨é¡
        if (uniqueDays >= 3) {
            accSunglasses.classList.add('unlocked');
            statusMsg = "æ±ªï¼æˆ‘æ˜¯è¡—é ­æœ€é…·çš„æŸ´çŠ¬ï¼ğŸ˜";
        } else {
            accSunglasses.classList.remove('unlocked');
        }

        // æ¢ä»¶ 2: å„²è“„ç‡ > 50% è§£é–çš‡å† 
        if (savingsRate >= 0.5 && (currentIncome - currentExpense) > 0) {
            accCrown.classList.add('unlocked');
            statusMsg = "æ±ªå—šï¼ä½ æ˜¯çœéŒ¢åœ‹ç‹ï¼ğŸ‘‘";
        } else {
            accCrown.classList.remove('unlocked');
        }

        growthText.innerText = statusMsg;
    }

    function addRecord() {
        const dateInput = document.getElementById('record-date').value;
        const desc = document.getElementById('desc').value;
        const amount = parseInt(document.getElementById('amount').value);
        const category = document.getElementById('category').value;
        const type = document.querySelector('input[name="type"]:checked').value;

        if (!dateInput || !desc || isNaN(amount)) {
            alert("æ±ªï¼æ—¥æœŸã€é …ç›®èˆ‡é‡‘é¡ç¼ºä¸€ä¸å¯å–”ï¼");
            return;
        }

        const newRecord = {
            id: Date.now(),
            date: dateInput,
            desc,
            amount,
            category,
            type
        };

        records.push(newRecord);
        localStorage.setItem(STORAGE_KEY, JSON.stringify(records));
        
        const recordYear = new Date(dateInput).getFullYear();
        const recordMonth = dateInput.split('-')[1];
        
        document.getElementById('year-filter').value = recordYear;
        document.getElementById('month-filter').value = recordMonth;
        
        updateUI();

        document.getElementById('desc').value = '';
        document.getElementById('amount').value = '';
    }

    function updateUI() {
        const historyDiv = document.getElementById('history');
        const selectedYear = document.getElementById('year-filter').value;
        const selectedMonth = document.getElementById('month-filter').value;
        const prefix = `${selectedYear}-${selectedMonth}`;
        
        historyDiv.innerHTML = '';
        let incomeTotal = 0, expenseTotal = 0;
        let catTotals = new Array(categories.length).fill(0);

        const filtered = records.filter(r => r.date.startsWith(prefix));

        if (filtered.length > 0) {
            const sorted = [...filtered].sort((a, b) => b.date.localeCompare(a.date) || b.id - a.id);
            
            sorted.forEach(item => {
                const isInc = item.type === 'æ”¶å…¥';
                if (isInc) incomeTotal += item.amount;
                else expenseTotal += item.amount;

                const div = document.createElement('div');
                div.className = `history-item ${isInc ? 'item-income' : 'item-expense'}`;
                div.innerHTML = `
                    <span class="item-info">
                        <span class="item-date">${item.date}</span>
                        <strong>ğŸ¾ [${item.type}] ${item.category}</strong>
                        <small style="color:#64748b">${item.desc}</small>
                    </span>
                    <span class="amount ${isInc ? 'amt-income' : 'amt-expense'}">
                        ${isInc ? '+' : '-'}$${item.amount}
                    </span>
                `;
                historyDiv.appendChild(div);

                if (!isInc) {
                    const idx = categories.indexOf(item.category);
                    if (idx !== -1) catTotals[idx] += item.amount;
                }
            });
        } else {
            historyDiv.innerHTML = `<p style="text-align: center; color: #94a3b8; padding: 20px;">æ±ªï¼${selectedYear}å¹´${selectedMonth}æœˆ é‚„æ²’æœ‰è¨˜å¸³ç´€éŒ„å–”ã€‚</p>`;
        }

        document.getElementById('total-income').innerText = `$${incomeTotal}`;
        document.getElementById('total-expense').innerText = `$${expenseTotal}`;
        document.getElementById('total-balance').innerText = `$${incomeTotal - expenseTotal}`;

        expenseChart.data.datasets[0].data = catTotals;
        expenseChart.update();

        // è§¸ç™¼éŠæˆ²åŒ–æª¢æŸ¥
        checkGrowth(incomeTotal, expenseTotal);
    }

    function exportCSV() {
        if (records.length === 0) return alert("æ±ªï¼æ²’æœ‰éª¨é ­å¯ä»¥åŒ¯å‡ºã€‚");
        let csv = "æ—¥æœŸ,é¡å‹,é¡åˆ¥,é …ç›®,é‡‘é¡\n";
        records.sort((a,b) => a.date.localeCompare(b.date)).forEach(r => {
            csv += `${r.date},${r.type},${r.category},${r.desc},${r.amount}\n`;
        });
        const blob = new Blob(["\ufeff" + csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = `SmartSpend_æˆ‘çš„è¨˜å¸³æœ¬.csv`;
        link.click();
    }

    function clearAll() {
        if (confirm("æ±ªï¼ç¢ºå®šè¦åŸ‹æ‰æ‰€æœ‰çš„ç´€éŒ„å—ï¼Ÿï¼ˆæ¸…é™¤å¾Œç„¡æ³•å¾©åŸï¼‰")) {
            records = [];
            localStorage.setItem(STORAGE_KEY, JSON.stringify(records));
            updateUI();
        }
    }
</script>

</body>
</html>